# VZLOGGING设计思路

指导:http://192.168.1.16/platform/vzlogging/

## 客户端
* 原则上客户端不输出日志到控制台
* 日志分级：INFO、WARNING、ERROR
* 共享内存读，获取服务器IP[PORT]，日志输出级别
* 一个线程绑定一个UDP Socket给服务器发送日志
* 一个线程绑定一个UDP Socket给服务器喂看门狗

```
graph TD
 A[开始] --> B[打开共享内存]
 B --> C[初始化日志模块]
 B --> D[初始化看门狗]
 C --> E[输出日志]
 E --> F[获取线程ID-KEY]
 F --> G{找KEY对应client}
 G --> |YES|H[重读IP:PORT:输出级别,组包UDP发送]
 G --> |NO|J[创建client]
 J --> H
 D --> K[重读IP:PORT,喂狗/45S]
```

## 服务端
* 增加运行参数实现控制台打印(-Vn,n指定输出级别)
* 使用select做UDP超时
* 共享内存写、读，写服务器IP[PORT]，日志保存级别
* 启动UDP Socket接收各个进程发送来的日志并存入文件
* 启动UDP Socket接收看门狗信号，定时判断进程是否挂掉，记录单独日志
* 日志文件限制大小，思考存储方案
   1. [x] 日志文件转档（最好存，不太便于查询）
   2. [ ] 自定义文件系统循环存储（空间浪费，最优查询）
   3. [ ] 同一个文件挪移写位置（最耗时，最不好做）
```
graph TD
 A[开始] --> B[写共享内存,IP:PORT,打印等级]
 B --> C[创建日志UDP服务]
 C --> D[等待接收日志数据包]
 D --> E{日志文件大小}
 E --> |小于|F[格式化写入日志文件]
 E --> |大于等于|G[日志转档]
 G --> F
 F --> D
 B --> H[创建看门狗UDP服务]
 H --> J[超时,接收喂狗数据包]
 J --> K{周期定时器,检查进程存活}
 K --> |存活|L[注册进程,刷新时间]
 L --> |等待喂狗|J
 K --> |连续两次没接收到喂狗|M[写入看门狗日志]
 M --> N[重启进程 or 重启设备]
```

