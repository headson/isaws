<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>服务器维护</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <script type="text/javascript" src="../js/LAB.min.js"></script>
    <style type="text/css">
        body {
            display: none;
        }
    </style>
    <script type="text/javascript">
        $LAB
        .script("../js/launch.js?version=" + new Date().getTime()).wait(function () {
            init(function () {
                function check_connection(call_back) {
                    $.get("../vb.htm?getnetip", function (ajaxdata) {
                        if (precheck(ajaxdata)) return false;
                        call_back();
                    });
                }

                function getupdatestatus(callback) {
                    var random = Math.floor(Math.random() * 3) + 2;
                    jindu_num = jindu_num + random;
                    $.get("../vb.htm?getupdatestatus", function (ajaxdata) {
                        if (precheck(ajaxdata)) {
                            return false;
                        }
                        if ("OK" != ajaxdata.slice(0, 2)) return false;
                        var decode = ajaxdata.slice(ajaxdata.indexOf("=") + 1, ajaxdata.length - 1);
                        callback(decode);
                    });
                }
                var save_num = 10;
                var verify_num = 40;
                var update_num = 60;
                function normal_state_parse(decode) {
                    if (decode == 1 && cur_state != decode) {
                        $("#warning_text").css("color", "Red");
                        $("#warning_text").html("正在保存升级文件...");
                        jindu_num = save_num;
                        cur_state = 1;
                    } else if (decode == 2 && cur_state != decode) {
                        $("#warning_text").css("color", "Red");
                        $("#warning_text").html("文件保存成功，正在校验升级文件...");
                        jindu_num = verify_num;
                        cur_state = 2;
                    } else if (decode == 3 && cur_state != decode) {
                        $("#warning_text").css("color", "Red");
                        $("#warning_text").html("文件校验成功，设备正在升级...");
                        jindu_num = update_num;
                        cur_state = 3;
                    }
                    if (cur_state == 1 && jindu_num > verify_num) {
                        jindu_num = verify_num;
                    }
                    if (cur_state == 2 && jindu_num > update_num) {
                        jindu_num = update_num;
                    }
                    if (jindu_num >= 99) {
                        jindu_num = 99;
                    }
                    if (loaded) {
                        return;
                    }
                    set_progressbar_val(jindu_num);
                }
                function set_progressbar_val(jindu_num) {
                    $("#progressbar").progressbar({
                        value: jindu_num
                    });
                    $(".progress-bar").css("width", jindu_num + "%");
                    $(".progress-label").html(jindu_num + "%");
                }

                var jindu_timer = null;
                var jindu_num = 0;
                var cur_state = 0;
                function getupdatestatus_time() {
                    $("#progressbar_tr").show();
                    if (jindu_timer == null) {
                        jindu_timer = setInterval(function () {
                            getupdatestatus(normal_state_parse);
                        }, 1000);
                    }
                }
                var file_name_flag = true;
                $(function () {
                    if (g_style_time == "sfm") {
                        $(".common_update_btn").remove();
                        $("#file_name").css("width", "300px");
                        $("#file_name").css("max-width", "300px");
                        $("#file_input").css("width", "400px");
                    } else {
                        $(".sfm_update_btn").remove();
                    }

                    //$("#file_input").change(function () {
                    //    var value = $(this).val();
                    //    if (value.substring(value.length - 4) != ".bin") {
                    //        file_name_flag = false;
                    //        alert("请选择正确的升级文件！");
                    //    } else {
                    //        file_name_flag = true;
                    //    }
                    //});
                    $("#frmUpdate").submit(function () {
                        loaded = false;
                        set_update_timeout_timer();
                        disable_other_btns();
                        $(".loading").show();
                        $("#warning_text").css("color", "Red");
                        $("#warning_text").html("正在升级中，请不要关闭网页和视频服务器！");
                        getupdatestatus_time();
                    });
                    $("#update").click(function () {
                        var value = $("#file_input").val();
                        if (value.substring(value.length - 4) != ".bin") {
                            alert("请选择正确的升级文件！");
                            return false;
                        } 
                        check_connection(function () {
                            set_progressbar_val(3);
                            $("#frmUpdate").submit();
                        });
                    });
                });
                var loaded = false;
                $(function () {
                    $("#restart").click(restart_ipnc);
                    $("#restart").css("width","100px");
                    $("#restart").val("重启服务器");
                    var ie = checkIeVersion();
                    if (g_style_time == "old") {                        
                        $("#file_input_btn").css("width", "70px");
                        $("#file_input_btn").css("font-size", "12px");
                    }
                    //ie8 will not send request when file input is hidden!
                    if (g_style_time == "old" || g_style_time == "hrzx" || (ie.isIE && (ie.version <= 10 || (ie.emulatedVersion != null && ie.emulatedVersion <= 10)))) {
                        $("#file_input_btn").hide();
                        $("#file_name").hide();
                        $("#file_input").show();
                    }
                    if (g_style_time == "sfm") {
                        $("#restart").css("width", "130px");
                        $("#file_input_btn").css("width", "130px");
                        $("#file_input_btn").css("font-size", "14px");
                        $(".dummy").css("margin-left","130px");
                    }
                    $("#file_input_btn").click(function () {                       
                        $("#file_input").click();
                        var path = $("#file_input").val().split('\\').pop();
                        $("#file_name").html(path);
                    });
                    $("#hidden_frame").on("load", on_iframe_loaded);
                    $("#blue_bar").css("transition", "none");
                    if ((g_oem_info == 1 || g_oem_info == 5) && g_hava_custom != 0) {
                        $("#hide_hint").show();
                        $("#restart").hide();
                    }
                });

                var check_restart_complete_timer = 0;
                function check_restart() {
                    $.get("../vb.htm?getnetip", function (ajaxdata) {
                        if (ajaxdata.length > 0 && ajaxdata[0] == '<') {
                            $("#warning_text").css("color", "Green");
                            $("#warning_text").html("重启完成，返回登录界面");
                            top.location.href = "../login.htm";
                            return false;
                        }
                    });
                }
                function check_restart_complete() {
                    if (check_restart_complete_timer == 0) {
                        check_restart_complete_timer = setInterval(check_restart, 10000);
                    }
                }
                function restart_ipnc() {
                    check_connection(function () {
                        $.get("../vb.htm", { ipcamrestartcmd: "" }, null);
                        $("#warning_text").css("color", "Green");
                        $("#warning_text").html("服务器已重启，请稍候...");
                        check_restart_complete();
                    });
                }



                var timer1;
                var restart_count = 1;//no wait
                function restart_time_count() {
                    restart_count--;
                    if (restart_count == 0) {
                        restart_count = 1;
                        clearInterval(timer1);
                        check_restart_complete();
                    }
                }
                function set_restart_timer() {
                    timer1 = setInterval(restart_time_count, 1000);
                }

                function disable_other_btns() {
                    $("#restart").attr("disabled", "disabled");
                    $("#update").attr("disabled", "disabled");
                }

                function enable_other_btns() {
                    $("#restart").removeAttr("disabled");
                    $("#update").removeAttr("disabled");
                }

                var timer_update_timeout = null;
                var is_update_timeout;

                function update_timeout3() {
                    clearTimeout(timer_update_timeout);
                    if (is_update_timeout3) {
                        top.location.href = "../login.htm";
                    }
                }
                function update_timeout2() {
                    is_update_timeout2 = true;
                    clearTimeout(timer_update_timeout);
                    timer_update_timeout = setTimeout(update_timeout3, 60 * 1000);
                }
                function update_timeout1() {
                    is_update_timeout1 = true;
                    clearTimeout(timer_update_timeout);
                    timer_update_timeout = setTimeout(update_timeout2, 190 * 1000);
                }
                function set_update_timeout_timer() {
                    if (timer_update_timeout) {
                        clearTimeout(timer_update_timeout);
                        timer_update_timeout = null;
                    }
                    is_update_timeout1 = false;
                    is_update_timeout2 = false;
                    is_update_timeout3 = false;
                    timer_update_timeout = setTimeout(update_timeout1, 50 * 1000);
                }
                function error_state() {
                    if (cur_state == 1) {
                        $("#warning_text").css("color", "Red");
                        $("#warning_text").html("保存文件失败，设备正在重置，网页正在跳转，请稍后...");
                        $("#progressbar_tr").hide();
                    } else if (cur_state == 2) {
                        $("#warning_text").css("color", "Red");
                        $("#warning_text").html("校验文件失败，设备正在重置，网页正在跳转，请稍后...");
                        $("#progressbar_tr").hide();
                    } else if (cur_state == 3) {
                        $("#warning_text").css("color", "Red");
                        $("#warning_text").html("升级失败，设备正在重置，网页正在跳转，请稍后...");
                        $("#progressbar_tr").hide();
                    }
                }
                function on_iframe_loaded() {
                    if (loaded) {
                        return;
                    }
                    clearInterval(jindu_timer);
                    jindu_timer = null;
                    loaded = true;
                    var r;
                    var error = false;
                    try {
                        r = getIFrameContent("hidden_frame");
                    }
                    catch (error) {
                        error = true;
                    }                    
                    $(".loading").hide();
                    if (error || r == undefined || r.length == 0) {
                        if (!is_update_timeout1) {
                            $("#warning_text").css("color", "Red");
                            $("#warning_text").html("请刷新网页或重启服务器,再尝试重新升级！");
                        }
                        else{
                            if (is_update_timeout2) {
                                set_progressbar_val(100);
                                $("#warning_text").css("color", "Green");
                                $("#warning_text").html("升级成功，服务器已重启，请稍候...");
                                set_restart_timer();
                            }
                            else {
                                is_update_timeout3 = true;
                                return;
                            }
                        }
                    }
                    else if (r.match(/All update success/)) {
                        set_progressbar_val(100);
                        $("#warning_text").css("color", "Green");
                        $("#warning_text").html("升级成功，服务器已重启，请稍候...");
                        set_restart_timer();
                    }
                    else if (r.match(/Unkown file format/)) {
                        error_state();
                        set_restart_timer();
                    }
                    else {
                        error_state();
                        set_restart_timer();
                    }
                }
                //取iframe的innerHTML
                function getIFrameContent(id) {
                    var hidden_fr = document.getElementById(id);
                    if (document.getElementById) {
                        if (hidden_fr && !window.opera) {
                            if (hidden_fr.contentDocument) {
                                return hidden_fr.contentDocument.body.innerHTML;
                            } else if (hidden_fr.Document) {
                                return hidden_fr.Document.body.innerHTML;
                            }
                        }
                    }
                }
                var g_enable = 0;
                function get_logging_status() {
                    var req = {};
                    req.type = "get_logging_status";
                    var jsonstr = JSON.stringify(req);
                    $.get("../vb.htm?loggingservies=" + jsonstr, function (ajaxdata) {
                        ajaxdata = ajaxdata.substring(ajaxdata.indexOf("=") + 1);
                        var json_data = eval("(" + ajaxdata + ")");
                        if (json_data.state == 200) {
                            var enable = json_data.logging_status;
                            if (enable == 1) {
                                $("#log_enable").check_val(true);
                                start_log();
                                g_enable = 1;
                            } else {
                                stop_log();
                                g_enable = 0;
                            }
                        }
                    });
                }

                function set_logging_status() {
                    var enable = $("#log_enable").check_val() ? 1 : 0;
                    var req = {};
                    req.type = "set_logging_status";
                    req.logging_status = enable;
                    var jsonstr = JSON.stringify(req);
                    $.get("../vb.htm?loggingservies=" + jsonstr, function (ajaxdata) {
                        ajaxdata = ajaxdata.substring(ajaxdata.indexOf("=") + 1);
                        var json_data = eval("(" + ajaxdata + ")");
                        if (json_data.state == 200) {
                            show_informer();
                            get_logging_status();
                        } else {
                            alert("保存失败");
                        }
                    });
                }

                var last_id = 0;
                function get_logging_record() {
                    stop_log();
                    var req = {};
                    req.type = "get_logging_record";
                    req.last_id = last_id;
                    var jsonstr = JSON.stringify(req);
                    $.get("../vb.htm?loggingservies=" + jsonstr, function (ajaxdata) {
                        ajaxdata = ajaxdata.substring(ajaxdata.indexOf("=") + 1);
                        var json_data = eval("(" + ajaxdata + ")");
                        last_id = json_data.last_id;
                        var log_arr = json_data.records;
                        for (var i = 0; i < log_arr.length; i++) {
                            var str = "[";
                            str += log_arr[i].millisec_str;
                            str += " ";
                            str += log_arr[i].proc_id;
                            str += " ";
                            str += log_arr[i].type;
                            str += "] :";
                            str += log_arr[i].msg;
                            str += "<br/>";
                            $("#log_container").html($("#log_container").html() + str);
                            $("#log_container")[0].scrollTop = $("#log_container")[0].scrollHeight - $("#log_container").height();
                        }
                        if (g_enable == 1) {
                            start_log();
                        }
                    });
                }

                var log_timer = null;
                function start_log() {
                    if (!log_timer) {
                        log_timer = setInterval(get_logging_record, 1000);
                    }
                }

                function stop_log() {
                    clearInterval(log_timer);
                    log_timer = null;
                }

                function get_softwareversion(ajaxdata) {
                    if (precheck(ajaxdata)) {
                        return false;
                    }
                    if (g_style_time == "hrzx")
                        $("#version").html("HR" + ajaxdata.split("=")[1]);
                    else
                        $("#version").html(ajaxdata.split("=")[1]);
                }

                function get_systemversion(ajaxdata) {
                    if (precheck(ajaxdata)) {
                        return false;
                    }
                    if (g_style_time == "hrzx")
                        $("#systemversion").html("HR" + ajaxdata.split("=")[1]);
                    else
                        $("#systemversion").html(ajaxdata.split("=")[1]);
                }
                function get_hwinfo(ajaxdata) {
                    if (precheck(ajaxdata)) {
                        return false;
                    }
                    ajaxdata = ajaxdata.split("=");
                    if (!ajaxdata[0].match(/OK/)) {
                        return false;
                    }
                    ajaxdata = ajaxdata[1];
                    if (ajaxdata.match(/notwrite/)) {
                        return false;
                    }
                    else {
                        ajaxdata = ajaxdata.split("^");
                        $("#serialno").html(ajaxdata[1]);
                        var g_iDevice_type = parseInt(ajaxdata[2], 16);
                        if (g_iDevice_type == 11) {
                            get_algversion();
                            $.get("../vb.htm?paratest=systemversion", get_systemversion);
                        }
                        else {
                            $("#algversion_tr").hide();
                            $("#sys_version_tr").hide();
                        }
                    }
                    return true;
                }
                function get_algversion() {
                    var cmd, len, data;

                    cmd = 6;
                    data = "0";
                    len = data.length;
                    var base64 = Base64.encode(data);
                    var senddata = cmd + ":" + len + ":" + base64;
                    $.ajax({
                        type: "POST",
                        url: "../getivsctrl.php",
                        data: senddata,
                        success: function (ajaxdata) {
                            if (precheck(ajaxdata)) {
                                return false;
                            }
                            if ("OK" != ajaxdata.slice(0, 2)) return false;
                            var decode = ajaxdata.slice(ajaxdata.indexOf("=") + 1, ajaxdata.length - 1);
                            decode = decode.split(":");
                            decode = Base64.decode(decode[2]);

                            if (g_style_time == "hrzx")
                                $("#algversion").html("HR" + decode)
                            else
                                $("#algversion").html(decode)
                        },
                        dataType: "text"
                    });
                }
                $(function () {
                    $.get("../vb.htm?gethwinfo", function (ajaxdata) {
                        get_hwinfo(ajaxdata);
                    });
                    $.get("../vb.htm?paratest=softwareversion", get_softwareversion);
                    $("#log_enable").change(function () {
                        set_logging_status();
                    });
                    get_logging_status();
                });
            });
        });
    </script>

</head>
<body>
    <div id="tabs" style="min-width: 850px;">
        <ul>
            <li><a href="#tabs-1">设备远程升级</a></li>
            <li><a href="#tabs-2">日志服务</a></li>
        </ul>
        <div id="tabs-1">
            <table class="dummy" style="margin:0;" cellpadding="0" cellspacing="0">
                <tr>
                    <td>
                        软件版本
                    </td>
                    <td id="version"></td>
                </tr>
                <tr id="sys_version_tr">
                    <td>
                        系统版本
                    </td>
                    <td id="systemversion"></td>
                </tr>
                <tr id="algversion_tr">
                    <td>
                        算法版本
                    </td>
                    <td id="algversion"></td>
                </tr>
                <tr><td>&nbsp;</td></tr>
                <tr>
                    <td>
                        选择本地升级文件
                    </td>

                    <td>
                        <form id="frmUpdate" method="post" enctype="multipart/form-data" action="../cgi-bin/update.cgi" target="hidden_frame">
                            <div id="file_name" style="width:200px;max-width:200px;display:inline-block"></div>
                            <input id="file_input_btn" type="button" value="浏览" />
                            <input id="file_input" type="file" name="file" style="display:none;height:20px;width:300px;" />
                            <input class="common_update_btn" type="button" id="update" value="升级" />
                        </form>
                    </td>
                </tr>
                <tr id="progressbar_tr" style="display:none;">
                    <td colspan="2" valign="top">
                        <div id="progressbar" class="progress" style="height:16px;position:relative;border:1px solid #c6c6c6;background:none;">
                            <div id="blue_bar" class="progress-bar" role="progressbar" aria-valuenow="60"
                                 aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
                            </div>
                        </div>
                    </td>
                    <td valign="top"><div class="progress-label">3%</div></td>
                </tr>
                <tr>
                    <td colspan="2" id="warning_text"></td>
                </tr>
                <tr>
                    <td></td>                   
                    <td>
                        <input class="sfm_update_btn" type="submit" id="update" value="升级" style="margin-right:60px;" />
                        <input type="submit" id="restart" value="重启服务器" />
                    </td>
                </tr>
                <tr style="display:none;" id="hide_hint">
                    <td style="color:red">
                        没有检测到网页包，请先升级网页包
                    </td>
                </tr>
            </table>            
        </div>
        <div id="tabs-2">
            <table class="dummy" style="margin:0;" cellpadding="0" cellspacing="0">
                <tr>
                    <td style="width:80px;">日志服务：</td>
                    <td style="width:50px;"><input type="checkbox" id="log_enable" /><label for="log_enable">开启</label></td>
                    <td style="width:770px;"></td>
                </tr>
                <tr>
                    <td colspan="3">
                        <div id="log_container" style="border:1px solid #ccc;overflow:auto;width:900px;height:500px;"></div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <iframe name='hidden_frame' id="hidden_frame" style="visibility:hidden;width:1px;height:1px;"></iframe>
    <div id="msgdiv" style="height:40px; margin-top:50px; margin-left:100px; font-size:13px; font-family: Arial '新宋体'; line-height: 20px;" />
</body>
</html>
