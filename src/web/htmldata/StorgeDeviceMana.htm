<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>视频设置</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <script type="text/javascript" src="../js/LAB.min.js"></script>
    <style type="text/css">
        body {
            display: none;
        }
    </style>
    <script type="text/javascript">
        $LAB
        .script("../js/launch.js?version=" + new Date().getTime()).wait(function () {
            init(function () {
                var g_hd_status = {};
                var DeviceNmae = {};
                var formartting = {};
                var IntervalId = 0;

                function format(id) {
                    var data = DeviceNmae[id] + ":" + "0";
                    var base64 = Base64.encode(data);
                    $.get("../vb.htm?storagedeviceformat=" + base64, function (ajaxdata) {
                        default_ajax_handler(ajaxdata);
                        init_device();
                    });
                }

                function hd_format(id) {
                    if (g_hd_status[id] == 3) {
                        alert("正在格式化");
                        return false;
                    }

                    var confirm_format = confirm("确定要格式化硬盘？格式化后数据不能恢复！");
                    if (!confirm_format) return false;

                    if (g_hd_status[id] == -1) {
                        var part = DeviceNmae[id] + ":" + "100";
                        var part64 = Base64.encode(part);
                        $.get("../vb.htm?storagedeviceparts=" + part64, function (ajaxdata) {
                            default_ajax_handler(ajaxdata);
                            format(id);
                        });
                    }
                    else {
                        format(id);
                    }
                }


                function get_device_info() {
                    $.get("../vb.htm?storagedeviceinfonew=" + 1, function (ajaxdata) {
                        if (precheck(ajaxdata)) {
                            return false;
                        }
                        if ("OK" != ajaxdata.slice(0, 2)) return false;
                        var slicestring = ajaxdata.slice(ajaxdata.indexOf("=") + 1, ajaxdata.length - 1);
                        var decode = Base64.decode(slicestring);
                        decode = decode.split(";");

                        var tr_ids = Array();
                        var i = 0;
                        while (decode[i]) {
                            var info = decode[i].split(",");
                            var main = info[0].split(":");
                            for (var j = 1; j < info.length; j++) {
                                var dev = info[j].split(":");
                                var name = dev[0].replace(/\//g, "");
                                DeviceNmae[name] = dev[0];

                                var type = "", status = "", capacity = "";
                                if (Number(main[1]) == 0) {
                                    type = "SD卡";
                                }
                                else if (Number(main[1]) == 1) {
                                    type = "硬盘";
                                }
                                var zone = dev[0].substring(dev[0].length - 1);
                                type = type + "/分区" + zone;

                                var num = Number(dev[1]);
                                g_hd_status[name] = num;

                                if (num == 3) {
                                    formartting[name] = true;
                                    var percent = Number(dev[5]);
                                    status = "格式化中(" + percent + "%)";
                                }
                                else if (num == 5) {
                                    if (g_style_time == "sfm" && formartting[name]) {
                                        sfm_cur_obj = formartting["obj_" + name];
                                        show_informer("格式化完成！！！");
                                        //alert("格式化完成！！！");
                                        formartting[name] = false;
                                    }
                                    status = "工作正常";
                                }
                                else {
                                    status = "未格式化";
                                }

                                var used = dev[2] / 1024;
                                used = used.toFixed(2);
                                var totle = dev[4] / 1024;
                                totle = totle.toFixed(2);
                                capacity = used + "G/" + totle + "G";

                                var tr_id = "tr" + DeviceNmae[name];
                                tr_id = tr_id.replace(/\//g, "_");
                                var old_tr = $("#" + tr_id);
                                if (old_tr.length == 0) {
                                    var tr = "";
                                    if (g_style_time == "sfm") {
                                        tr = '<tr id="' + tr_id + '" class="' + tr_id + '"><td>' + type + '</td><td>' + status + '</td><td>' + capacity + '</td></tr><tr class="' + tr_id + '"><td colspan="3" style="border:none;padding-top:50px;"><input type="submit" order="' + name + '" id="format_hd_' + name + '" value="格式化"/></td></tr><tr  class="' + tr_id + '"><td valign="middle" style="display:none;border:none;" colspan="3" class="sfm_info"></td></tr>';
                                    } else {
                                        tr = '<tr id="' + tr_id + '" class="' + tr_id + '"><td>' + type + '</td><td>' + status + '</td><td>' + capacity + '</td><td><input type="submit" order="' + name + '" id="format_hd_' + name + '" value="格式化"/>	</td></tr>';
                                    }

                                    $("#devicetable").append(tr);
                                    $("#devicetable td").attr("align", "center");
                                    $("#format_hd_" + name).button();
                                    $("#format_hd_" + name).click(function () {
                                        var id = $(this).attr("order");
                                        formartting["obj_" + id] = $(this);
                                        hd_format(id);
                                    });
                                }
                                else {
                                    old_tr.children().eq(1).text(status);
                                    old_tr.children().eq(2).text(capacity);
                                }

                                tr_ids.push(tr_id);
                            }
                            i++;
                        }
                        var all_trs = $("#devicetable tr");
                        var trs_need_remove = Array();
                        for (var i = 1; i < all_trs.length; i++) {
                            var found = false;
                            var id = all_trs.eq(i).attr("class");
                            for(var j=0;j<tr_ids.length;j++){
                                if (id == tr_ids[j]) {
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) trs_need_remove.push(id);
                        }
                        for (var i = 0; i < trs_need_remove.length; i++) {
                            $("." + trs_need_remove[i]).remove();
                        }
                    });
                }

                function init_device() {
                    var tr = $("#devicetable tr");
                    if (tr.length == 0) {
                        var tr = "";
                        if (g_style_time == "sfm") {
                            tr = "<tr class=\"ui-widget-header\"><th width=\"60px\">设备</th><th width=\"60px\">状态</th><th width=\"100px\">已使用/总量</th></tr>";
                        } else {
                            tr = "<tr class=\"ui-widget-header\"><th width=\"60px\">设备</th><th width=\"60px\">状态</th><th width=\"100px\">已使用/总量</th><th width=\"60px\"></th></tr>";
                        }
                        $("#devicetable").append(tr);
                    }
                    get_device_info();
                }

                $(function () {
                    if (g_style_time == "sfm") {
                        $("#devicetable").removeClass("ui-widget-content");
                    }
                    init_device();
                    setInterval(init_device, 3000);
                });
            });
        });
    </script>
</head>
<body>
    <div id="tabs">
        <ul>
            <li><a href="#tabs-1">存储设备</a></li>
        </ul>
        <div id="tabs-1">
            <table id="devicetable" class="ui-widget ui-widget-content realtable paddingtb" style="font-size:12px; margin: 0;width:450px" cellpadding="0" cellspacing="0"></table>
        </div>
    </div>
</body>
</html>
