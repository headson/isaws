<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>用户管理</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <script type="text/javascript" src="../js/LAB.min.js"></script>
    <style type="text/css">
        body {
            display: none;
        }
    </style>
    <script type="text/javascript">
        $LAB
        .script("../js/launch.js?version=" + new Date().getTime()).wait(function () {
            init(function () {
                function get_users(ajaxdata) {
                    if (precheck(ajaxdata)) {
                        return false;
                    }
                    ajaxdata = ajaxdata.split("\n\n");
                    var users = ajaxdata[0].split("=")[1].split("\n");
                    var len = 0;
                    for (; len < users.length; len++) {
                        users[len] = users[len].split(":")[1];
                        if (users[len] == "")
                            break;
                    }
                    users.length = len;
                    var authorities = ajaxdata[1].split("=")[1].split("\n");
                    authorities.length = len;
                    for (var i = 0; i < len; i++) {
                        authorities[i] = authorities[i].split(":")[1];
                        switch (authorities[i]) {
                            case '0':
                                authorities[i] = '管理员';
                                break;
                            case '1':
                                authorities[i] = '操作员';
                                break;
                            case '2':
                                authorities[i] = '观察员';
                                break;
                            case '9':
                            default:
                                authorities[i] = 'None';
                        }
                    }

                    if ($("#table_users tr").length > 1) {
                        $("#table_users tr:gt(0)").remove();
                    }

                    for (var i = 0; i < len; i++) {
                        var tr = "";
                        if (i == 0) {
                            tr = '<tr><td>' + users[i] + '</td><td>' + authorities[i] + '</td><td class="edit_user">编辑</td><td></td></tr>';
                        }
                        else {
                            tr = '<tr><td>' + users[i] + '</td><td>' + authorities[i] + '</td><td class="edit_user">编辑</td><td class="del_user">删除</td></tr>';
                        }
                        $("#table_users").append(tr);
                    }

                    //for appearance
                    var tablelen = $("#table_users tr").length;
                    if (tablelen < 4) {
                        for (var i = 0; i < 4 - tablelen; i++) {
                            var tr = '<tr><td> &nbsp;</td><td></td><td></td><td></td></tr>';
                            $("#table_users").append(tr);
                        }
                    }
                    $("#table_users td").attr("align", "center");
                    $(".edit_user").click(function () {
                        $("#username").val($(this).siblings().first().html());
                        var auth = $(this).siblings(":eq(1)").html();
                        if (auth == "管理员") {
                            auth = 0;
                        }
                        else if (auth == "操作员") {
                            auth = 1;
                        }
                        else {
                            auth = 2;
                        }

                        $("input[name=radio]:eq(" + auth + ")").check_val(true);
                        $("#usrpwd").val("");
                        $("#confirmpwd").val("");
                        $("#usrpwd").focus();
                        return false;
                    });
                    $(".del_user").click(function () {
                        var username = $(this).siblings().first().html();
                        var outtext = $.cookie('outtext');
                        passwd = "天天";
                        var postdata = AesCtr.decrypt(outtext, passwd, 128);
                        postdata = postdata.split(':');

                        if (username == postdata[0]) {
                            alert("不能删除当前登录的用户，请使用其他用户登录后再尝试！");
                            return;
                        }
                        if (confirm("你确定要删除用户" + username + "吗？")) {
                            $.get("../vb.htm?deluser=" + username, function (ajaxdata) {
                                if (precheck(ajaxdata)) {                                    
                                    return false;
                                }
                                if (ajaxdata.split(" ")[0] == "OK") {
                                    alert("删除成功");
                                }
                                $.get("../vb.htm?paratest=user&paratest=authority", get_users);
                            });
                        }
                    });
                }
                function on_submit() {
                    var username = $("#username").val();
                    if (username.length == 0) {
                        alert('请输入用户名');
                    }
                    else if (!username.match(/^.{4,33}$/)) {
                        alert('提示：用户名长度必须在4-33之内');
                    }
                    else if (!username.match(/^[a-zA-Z]{1}/)) {
                        alert('提示：用户名首字母必须为字母');
                    }
                    else if (!username.match(/^\w{1,33}$/)) {
                        alert('提示：用户名只能包含字母数字或下划线');
                    }
                    else {
                        var pwd = $("#usrpwd").val();
                        var pwd1 = $("#confirmpwd").val();
                        if (pwd.length == 0) {
                            alert("密码不能为空");
                        }
                        else if (pwd1.length == 0) {
                            alert("请确定密码");
                        }
                        else if (pwd.length > 33 || pwd1.length > 33) {
                            alert("密码长度不能超过33个字符");
                        }
                        else if (pwd != pwd1) {
                            alert("两次输入密码不符");
                        }
                        else if (pwd.match(/[:]{1}/)) {
                            alert("密码中不能包含':'字符");
                        }
                        else {
                            var auth;
                            if ($("#radio1").check_val()) {
                                auth = 0;
                            }
                            else if ($("#radio2").check_val()) {
                                auth = 1;
                            }
                            else if ($("#radio3").check_val()) {
                                auth = 2;
                            }
                            else {
                                alert("请选择权限");
                                return false;
                            }
                            var postdata = username + ":" + pwd + ":" + auth;
                            passwd = "天天";
                            var outtext = AesCtr.encrypt(postdata, passwd, 128);
                            $.get("../vb.htm?adduser=" + outtext, function (ajaxdata) {
                                if (precheck(ajaxdata)) {
                                    return false;
                                }
                                if (ajaxdata.split(" ")[0] == "OK") {
                                    alert("设置成功");
                                }
                                $.get("../vb.htm?paratest=user&paratest=authority", get_users);
                            });
                        }
                    }
                }

                function userchargeenable() {
                    $.ajax({
                        url: get_main_path() + "vb.htm?userchargeenable",
                        success: function (ajaxdata) {
                            if ("OK" != ajaxdata.slice(0, 2)) return false;
                            var slicestring = ajaxdata.substring(ajaxdata.indexOf("=") + 1);
                            if (slicestring == 1 && g_cur_style != "blue") {
                                $("#page_td").show();
                            }   
                        }
                    });
                }

                $(function () {
                    $.get("../vb.htm?paratest=user&paratest=authority", get_users);
                    $("#submit").click(on_submit);
                    $("#gotopage").click(function () {
                        parent.document.location.href = "user_html/web_root/index.html";
                    });
                    userchargeenable();
                });
            });
        });
    </script>

</head>
<body>
    <table class="dummy" border="0" align="center" style="margin-top:30px">
        <tr>
            <td style="min-width:100px;" width="120">
                用户名
            </td>
            <td colspan="2">
                <input id="username" type="text" size="25" style="width:170px;" />
            </td>
        </tr>
        <tr>
            <td>
                密码
            </td>
            <td colspan="2">
                <input id="usrpwd" type="password" size="25" style="width:170px;" />
            </td>
        </tr>
        <tr>
            <td>
                确定密码
            </td>
            <td colspan="2">
                <input id="confirmpwd" type="password" size="25" style="width:170px;" />
            </td>
        </tr>
        <tr>
            <td>
                权限
            </td>
            <td colspan="2" style="min-width:300px;">
                <div class="checkdiv" style="min-width:70px;">
                    <input name="radio" id="radio1" type="radio" />
                    <label for="radio1">管理员&nbsp;</label>
                </div>
                <div class="checkdiv" style="min-width:70px;">
                    <input name="radio" id="radio2" type="radio" />
                    <label for="radio2">操作员</label>
                </div>
                <div class="checkdiv" style="min-width:70px;">
                    <input name="radio" id="radio3" type="radio" />
                    <label for="radio3">观察员</label>
                </div>

            </td>
        </tr>
        <tr>
            <td></td>
            <td width="59" align="right">
                <input id="submit" type="submit" value="确定" />
            </td>
            <td style="display:none;" id="page_td">
                <input id="gotopage" type="submit" style="width:100px" value="自定义网页" />
            </td>
        </tr>
    </table>
    <p>
        &nbsp;
    </p>
    <table id="table_users" class="ui-widget ui-widget-content realtable" width="624" align="center" cellpadding="0" cellspacing="0">
        <tr class="ui-widget-header">
            <td width="124" align="center">
                用户名
            </td>
            <td width="124" align="center">
                权限
            </td>
            <td width="100" align="center">
                编辑
            </td>
            <td width="100" align="center">
                删除
            </td>
        </tr>
        <tr>
            <td>
                &nbsp;
            </td>
            <td>
                &nbsp;
            </td>
            <td>
                &nbsp;
            </td>
            <td>
                &nbsp;
            </td>
        </tr>
        <tr>
            <td>
                &nbsp;
            </td>
            <td>
                &nbsp;
            </td>
            <td>
                &nbsp;
            </td>
            <td>
                &nbsp;
            </td>
        </tr>
        <tr>
            <td>
                &nbsp;
            </td>
            <td>
                &nbsp;
            </td>
            <td>
                &nbsp;
            </td>
            <td>
                &nbsp;
            </td>
        </tr>
    </table>
</body>
</html>
