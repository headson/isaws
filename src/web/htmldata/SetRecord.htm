<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>录像设置</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script type="text/javascript" src="../js/LAB.min.js"></script>
    <style type="text/css">
        body {
        display: none;
        }
    </style>
    <script type="text/javascript">
        $LAB
        .script("../js/launch.js").wait(function () {
            init(function () {
                var g_chnnum_max;
                var recordconfig = Array();

                function get_recordconfig() {
                    $.get("../vb.htm?paratest=recordconfig." + g_chnnum_max, function (ajaxdata) {
                        if (precheck(ajaxdata)) {
                            return false;
                        }
                        if ("OK" != ajaxdata.slice(0, 2)) return false;
                        var slicestring = ajaxdata.slice(ajaxdata.indexOf("=") + 1, ajaxdata.length - 1);
                        var response = slicestring.split(";");
                        for (var i = 0; i < g_chnnum_max; i++) {
                            recordconfig[i] = response[i];
                        }

                        $("#recordtable tr").remove();
                        var tr = "";
                        tr = "<tr class=\"ui-widget-header\"><th width=\"60px\">通道</th><th width=\"60px\">存储位置</th><th width=\"60px\">截图间隔(s)</th><th width=\"60px\">截图</th><th width=\"60px\">录像</th></tr>";
                        $("#recordtable").append(tr);
                        for (var i = 0; i < g_chnnum_max; i++) {
                            var data = recordconfig[i].split(":");
                            var chn = i + 1;
                            var selid = "ware" + i;
                            var timeid = "timerecord" + i;
                            var checkjpgid = "jpg" + i;
                            var recordid = "record" + i;
                            tr = '<tr><td>' + chn + '</td><td><select id=' + selid + ' style="width: 5em"><option value="0">硬盘</option></select></td><td><input id=' + timeid + ' type="text" size="5" style="text-align:center"/></td><td><input id=' + checkjpgid + ' type="checkbox" /></td><td><input id=' + recordid + ' type="checkbox" /></td></tr>';
                            $("#recordtable").append(tr); //<option value="1">SD卡</option>

                            init_checkbox("#" + checkjpgid);
                            init_checkbox("#" + recordid);
                            //	set_select_value(selid,Number(data[0]));
                            $("#" + selid).val(data[0]);
                            $("#" + timeid).val(data[2]);
                            $("#" + checkjpgid).check_val(Number(data[3]) == 1);
                            $("#" + recordid).check_val(Number(data[4]) == 1);
                            //	$("#" + checkjpgid).checkBox('changeCheckStatus', Number(data[3])==1);
                            //	$("#" + recordid).checkBox('changeCheckStatus', Number(data[4])==1);
                        }
                        $("#recordtable td").attr("align", "center");
                    });
                }

                function store_recordconfig(channel, data) {
                    $.get("../vb.htm?recordconfig=" + data + "." + channel, function (ajaxdata) {
                        if (!default_ajax_handler(ajaxdata)) {
                            return false;
                        }
                    });
                }

                function set_recordconfig() {
                    for (var i = 0; i < g_chnnum_max; i++) {
                        var data = "";
                        var selid = "ware" + i;
                        var timeid = "timerecord" + i;
                        var checkjpgid = "jpg" + i;
                        var recordid = "record" + i;

                        //				var ware = $("#" + selid).selectmenu("value");
                        var ware = $("#" + selid).val();
                        var time = $("#" + timeid).val();
                        var enablejpg = $("#" + checkjpgid).check_val() ? "1" : "0";
                        var enablerecord = $("#" + recordid).check_val() ? "1" : "0";

                        if (isNaN(time) || time <= 0) {
                            alert("时间必须为大于1的整数。");
                            return false;
                        }
                        data = ware + ":" + ware + ":" + time + ":" + enablejpg + ":" + enablerecord;
                        if (data != recordconfig[i]) {
                            recordconfig[i] = data;
                            store_recordconfig(i, data);
                        }
                    }
                }

                function changeenable(id) {
                    var enable = $("#" + id).check_val() ? "1" : "0";
                    var sub_string = id.substring(6);
                    var ftpid = "ftp" + sub_string;
                    var smtpid = "smtp" + sub_string;

                    if (enable == 1) {
                        $("#" + ftpid).attr("disabled", false);
                        $("#" + smtpid).attr("disabled", false);
                    }
                    else {
                        $("#" + ftpid).attr("disabled", true);
                        $("#" + smtpid).attr("disabled", true);
                    }
                }

                var g_enable_alarm_linkage = null;
                var g_alarm_linkage_num = null;
                var g_alarm_linkage_data = null;
                var g_alarm_linkages = Array();

                function append_alarm_linkage_tr(i) {
                    var data = g_alarm_linkages[i];
                    var selectedid = "selected" + i;
                    var enableid = "enable" + i;
                    var ftpid = "ftp" + i;
                    var smtpid = "smtp" + i;
                    var timeid = "time" + i;
                    var countid = "count" + i;
                    tr = '<tr><td><input id=' + selectedid + ' type="checkbox"/></td><td>' + data[0] + '</td><td><input id=' + enableid + ' type="checkbox"/></td><td><input id=' + timeid + ' type="text" size="5" style="text-align:center"/></td><td><input id=' + countid + ' type="text" size="5" style="text-align:center"/></td><td><input id=' + ftpid + ' type="checkbox" /></td><td><input id=' + smtpid + ' type="checkbox" /></td></tr>';
                    $("#alarmtable").append(tr);
                    init_checkbox("#" + selectedid);
                    init_checkbox("#" + enableid);
                    init_checkbox("#" + ftpid);
                    init_checkbox("#" + smtpid);
                    //$("#" + enableid).click(function () {
                    //    changeenable(enableid);
                    //});
                    $("#" + enableid).check_val(Number(data[1]) == 1);
                    $("#" + timeid).val(data[2]);
                    $("#" + countid).val(data[3]);
                    $("#" + ftpid).check_val(Number(data[4]) == 1);
                    $("#" + smtpid).check_val(Number(data[5]) == 1);

                    if (Number(data[1]) == 0) {
                        $("#" + ftpid).attr("disabled", true);
                        $("#" + smtpid).attr("disabled", true);
                    }
                    $("#alarmtable td").attr("align", "center");
                }

                function setup_alarm_table() {
                    $("#alarmtable tr").remove();
                    var tr = "";
                    tr = "<tr class=\"ui-widget-header\"><th width=\"30px\"\><th width=\"60px\">联动id</th><th width=\"80px\">报警截图</th><th width=\"100px\">截图间隔时间(ms)</th><th width=\"100px\">一次报警截图数量</th><th width=\"80px\">截图FTP上传</th><th width=\"80px\">截图邮件上传</th></tr>";
                    $("#alarmtable").append(tr);
                    for (var i = 0; i < g_alarm_linkages.length; i++) {
                        append_alarm_linkage_tr(i);
                    }
                }

                function delete_alarm_linkage() {
                    var deleted = false;
                    var len = g_alarm_linkages.length;
                    for (var i = 0; i < len; i++) {
                        var selectedid = "selected" + i;
                        if ($("#" + selectedid).check_val()) {
                            deleted = true;
                            var linkid = $("#" + selectedid).parent().next().html();
                            for (var j = 0; j < g_alarm_linkages.length; j++) {
                                if (g_alarm_linkages[j][0] == linkid) {
                                    g_alarm_linkages.splice(j, 1);
                                    break;
                                }
                            }
                        }
                    }
                    if (!deleted) {
                        alert("请选择至少一项来删除！");
                        return;
                    }
                    setup_alarm_table();
                }

                function add_alarm_linkage() {
                    if (g_alarm_linkages.length >= 8) {
                        alert("报警联动个数最多8个！");
                        return;
                    }
                    var linkid = 0
                    for (; linkid < 8; linkid++) {
                        var found = false;
                        for (var i = 0; i < g_alarm_linkages.length; i++) {
                            if (g_alarm_linkages[i][0] == linkid) {
                                found = true;
                                break;
                            }
                        }
                        if (!found) break;
                    }
                    g_alarm_linkages[g_alarm_linkages.length] = [linkid, 1, 300, 3, 1, 1];
                    append_alarm_linkage_tr(g_alarm_linkages.length - 1);
                }

                function get_alarmcfg() {
                    $.get("../vb.htm?paratest=getalarmcfg", function (ajaxdata) {
                        if (precheck(ajaxdata)) {
                            return false;
                        }
                        if ("OK" != ajaxdata.slice(0, 2)) return false;
                        var response = ajaxdata.slice(ajaxdata.indexOf("=") + 1, ajaxdata.length - 1);
                        response = response.split(";");
                        response[0] = response[0].split(":");
                        g_enable_alarm_linkage = response[0][0];
                        g_alarm_linkage_num = response[0][1];
                        for (var i = 0; i < g_alarm_linkage_num; i++) {
                            g_alarm_linkage_data = response[i + 1];
                            g_alarm_linkages[i] = response[i + 1].split(':');
                        }
                        $("#enable_alarm_linkage").check_val(g_enable_alarm_linkage == "1");
                        setup_alarm_table();
                    });
                }

                function set_alarmcfg() {
                    var changed = false;
                    var len = g_alarm_linkages.length;
                    var enable_alarm_linkage = $("#enable_alarm_linkage").check_val() ? "1" : "0";
                    if (enable_alarm_linkage != g_enable_alarm_linkage || len != g_alarm_linkage_num) {
                        changed = true;
                    }
                    var all_data = "";
                    for (var i = 0; i < len; i++) {
                        var data = "";
                        var enableid = "enable" + i;
                        var timeid = "time" + i;
                        var countid = "count" + i;
                        var ftpid = "ftp" + i;
                        var smtpid = "smtp" + i;

                        var enable = $("#" + enableid).check_val() ? "1" : "0";
                        var ftp = $("#" + ftpid).check_val() ? "1" : "0";
                        var smtp = $("#" + smtpid).check_val() ? "1" : "0";
                        var time = $("#" + timeid).val();
                        var count = $("#" + countid).val();
                        if (isNaN(time)) {
                            alert("请输入正确的截图间隔时间！");
                            return;
                        }
                        if (time < 200 || time > 1000 * 60 * 60) {
                            alert("截图的间隔时间应该在[200ms]-[3600000ms(1小时)]之间！");
                            return;
                        }
                        if (isNaN(count)) {
                            alert("请输入正确的截图数量！");
                            return;
                        }

                        if (count > 8) {
                            alert("一次报警截图数量应该小于8张！");
                            return;
                        }

                        data = g_alarm_linkages[i][0] + ":" + enable + ":" + time + ":" + count + ":" + ftp + ":" + smtp;
                        var data_old = g_alarm_linkages[i][0] + ":" + g_alarm_linkages[i][1] + ":" + g_alarm_linkages[i][2] + ":"
                                     + g_alarm_linkages[i][3] + ":" + g_alarm_linkages[i][4];
                        if (data != data_old) {
                            changed = true;
                        }
                        all_data += ";" + data;
                    }
                    if (changed) {
                        var all_data = enable_alarm_linkage + ":" + len + all_data;
                        $.get("../vb.htm?setalarmconfig=" + all_data, function (ajaxdata) {
                            if (default_ajax_handler(ajaxdata)) {
                                get_alarmcfg();
                            }
                        });
                    }
                }

                function init() {
                    $.get("../vb.htm?getdevicesupport", function (ajaxdata) {
                        if (precheck(ajaxdata)) {
                            return false;
                        }

                        if ("OK" != ajaxdata.slice(0, 2))
                            return false;

                        var slicestring = ajaxdata.slice(ajaxdata.indexOf("=") + 1, ajaxdata.length - 1);
                        var response = slicestring.split(",");
                        g_chnnum_max = Number(response[0]);
                        get_alarmcfg();
                        get_recordconfig();
                    });
                }

                $(function () {
                    $("#alarmstoreconfig").click(set_alarmcfg);
                    $("#secdstoreconfig").click(set_recordconfig);
                    $("#add_alarm_linkage").click(add_alarm_linkage);
                    $("#delete_alarm_linkage").click(delete_alarm_linkage);
                    init();
                });
            });
        });
    </script>
</head>
<body>
    <div id="tabs">
        <ul>
            <li><a href="#tabs-1">报警</a></li>
            <li><a href="#tabs-2">计划</a></li>
        </ul>
        <div id="tabs-1">
            <table class="dummy" border="0">
                <tr>
                    <td>
                        <input id="enable_alarm_linkage" type="checkbox" />
                        <label for="enable_alarm_linkage">
                            开启报警联动
                        </label>
                    </td>
                    <td align="right">
                        <input id="add_alarm_linkage" type="submit" value="添加" />
                        <input id="delete_alarm_linkage" type="submit" value="删除" />
                        <input id="alarmstoreconfig" type="submit" value="保存" />
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <table id="alarmtable" class="ui-widget ui-widget-content realtable" style="font-size: 12px;
                            margin: 0; width: 450px" cellpadding="0" cellspacing="0"></table>
                    </td>
                </tr>
            </table>
        </div>
        <div id="tabs-2">
            <table class="dummy" style="margin: 0">
                <tr>
                    <td>
                        <table id="recordtable" class="ui-widget ui-widget-content realtable" style="font-size: 12px;
                            margin: 0; width: 450px" cellpadding="0" cellspacing="0"></table>
                    </td>
                </tr>
                <tr>
                    <td align="right">
                        <input id="secdstoreconfig" type="submit" value="保存配置" />
                    </td>
                </tr>
            </table>
        </div>
    </div>  
</body>
</html>
