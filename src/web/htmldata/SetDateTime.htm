<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>设置日期/时间</title>

    <script type="text/javascript" src="../js/LAB.min.js"></script>
    <style type="text/css">
        body {
            display: none;
        }
    </style>
    <script type="text/javascript">
        $LAB
        .script("../js/launch.js?version=" + new Date().getTime()).wait(function () {
            init(function () {
                Date.prototype.format = function(format) //author: meizz
                {
                    var o = {
                        "M+" : this.getMonth()+1, //month
                        "D+" : this.getDate(),    //day
                        "h+" : this.getHours(),   //hour
                        "m+" : this.getMinutes(), //minute
                        "s+" : this.getSeconds(), //second
                        "q+" : Math.floor((this.getMonth()+3)/3),  //quarter
                        "S" : this.getMilliseconds() //millisecond
                    }
                    if(/(Y+)/.test(format)) format=format.replace(RegExp.$1,
                      (this.getFullYear()+"").substr(4 - RegExp.$1.length));
                    for(var k in o)if(new RegExp("("+ k +")").test(format))
                        format = format.replace(RegExp.$1,
                          RegExp.$1.length==1 ? o[k] :
                            ("00"+ o[k]).substr((""+ o[k]).length));
                    return format;
                }
                //global var
                var g_systime = 0;
                function settime()
                {
                    g_systime+=1000;
                    var local_date = new Date();
                    var ld = local_date.format("MM/DD/YYYY");
                    var lt = local_date.format("hh:mm:ss");
                    var sys_date = new Date(g_systime);
                    var sd = sys_date.format("MM/DD/YYYY");
                    var st = sys_date.format("hh:mm:ss");
                    if($("#localdate").val()!=ld)
                    {
                        $("#localdate").val(ld);
                    }
                    if($("#localtime").val()!=lt)
                    {
                        $("#localtime").val(lt);
                    }
                    if($("#serverdate").val()!=sd)
                    {
                        $("#serverdate").val(sd);
                    }
                    if($("#servertime").val()!=st)
                    {
                        $("#servertime").val(st);
                    }
                }

                function set_g_systime(ajaxdata)
                {
                    if(precheck(ajaxdata))
                    {
                        return false;
                    }
                    response=ajaxdata.split("\n");
                    var msgdate = parse_ajax_data(response[0]);
                    msgdate = msgdate.split("-");
                    var year = msgdate[0];
                    var month = msgdate[1]-1;
                    var date = msgdate[2];
                    var msgtime = parse_ajax_data(response[1]);
                    msgtime = msgtime.split(":");
                    var hours = msgtime[0];
                    var minutes = msgtime[1];
                    var seconds = msgtime[2];
                    var sys_date = new Date(year, month, date, hours, minutes, seconds);
                    g_systime = sys_date.getTime();
                    settime();
                }
                var settime_timer = null;
                function get_server_date(ajaxdata)
                {
                    if(precheck(ajaxdata))
                    {
                        return false;
                    }
                    set_g_systime(ajaxdata);
                    settime();
                    if (settime_timer == null) {
                        settime_timer = setInterval(settime, 1000);
                    }
                }

                var g_ntp_server_name=null;
                var g_ntp_frequency=null;
                var g_ntp_enable=null;
                function get_ntp(){
                    $.get("../vb.htm?paratest=ntp", function(ajaxdata){
                        if(precheck(ajaxdata))
                        {
                            return false;
                        }
                        if("OK" != ajaxdata.slice(0,2)) return false;
                        var slicestring = ajaxdata.slice(ajaxdata.indexOf("=")+1,ajaxdata.length-1);
                        var decode = Base64.decode(slicestring);
                        decode = decode.split(":");
                        $("#ntp_server_name").val(decode[0]);
                        $("#ntp_enable").check_val(decode[2]==1);
                        g_ntp_server_name = decode[0];
                        g_ntp_frequency = decode[1];
                        g_ntp_enable = decode[2];
                        var ntp_frequency_hour = Math.floor(g_ntp_frequency/3600);
                        var ntp_frequency_minute = Math.floor((g_ntp_frequency%3600)/60);
                        var ntp_frequency_second = (g_ntp_frequency%3600)%60;
                        $("#ntp_frequency_hour").select_val(ntp_frequency_hour);
                        $("#ntp_frequency_minute").select_val(ntp_frequency_minute);
                        $("#ntp_frequency_second").select_val(ntp_frequency_second);
                    });
                }

                function set_ntp() {
                    sfm_cur_obj = $(this);
                    var ntp_server_name = $("#ntp_server_name").val();
                    //var reg_str = /^[0-9a-z]+[\.]?[0-9a-z-]*\.[a-zA-Z]{2,4}$/;
                    var reg_str = /[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?/;
                    if (!reg_str.test(ntp_server_name)) {
                        alert("请输入正确的地址");
                        return;
                    }
                    var ntp_frequency_hour = parseInt($("#ntp_frequency_hour").val());
                    var ntp_frequency_minute = parseInt($("#ntp_frequency_minute").val());
                    var ntp_frequency_second = parseInt($("#ntp_frequency_second").val());
                    var ntp_frequency = ntp_frequency_hour*3600 + ntp_frequency_minute*60 + ntp_frequency_second;
                    var ntp_enable = $("#ntp_enable").check_val()?"1":"0";
                    if(ntp_server_name!=g_ntp_server_name || ntp_frequency!=g_ntp_frequency || ntp_enable!=g_ntp_enable ){
                        var data = ntp_server_name + ":"+ ntp_frequency + ":" + ntp_enable;
                        var base64 = Base64.encode(data);
                        $.get("../vb.htm?ntp="+base64,function(ajaxdata){
                            default_ajax_handler(ajaxdata);
                            get_ntp();
                        });
                    }
                }

                function get_server_datatime() {
                    $.get("../vb.htm", { getdate: "", gettime: "" }, get_server_date);
                }

                function get_plate_timezone() {
                    var cfg = {};
                    cfg.type = "AVS_GET_PLATE_TIMEZONE";
                    var jsonstr = JSON.stringify(cfg);
                    $.get("../vb.htm?avsalgresultparam=" + jsonstr,
                    function (ajaxdata) {
                        if (precheck(ajaxdata)) {
                            return false;
                        }
                        if ("OK" != ajaxdata.slice(0, 2)) return false;
                        ajaxdata = ajaxdata.substring(ajaxdata.indexOf("=") + 1);
                        var jsondata = eval("(" + ajaxdata + ")");
                        $("#plate_timezone").select_val(jsondata.body.timezone);
                    });
                }

                function set_plate_timezone() {
                    var timezone = $("#plate_timezone").select_val();
                    var cfg = {};
                    cfg.type = "AVS_SET_PLATE_TIMEZONE";
                    cfg.body = {};
                    cfg.body.timezone = parseInt(timezone);
                    var jsonstr = JSON.stringify(cfg);
                    $.get("../vb.htm?avsalgresultparam=" + jsonstr,
                    function (ajaxdata) {
                        if (precheck(ajaxdata)) {
                            return false;
                        }
                        if ("OK" != ajaxdata.slice(0, 2)) return false;
                        ajaxdata = ajaxdata.substring(ajaxdata.indexOf("=") + 1);
                        var jsondata = eval("(" + ajaxdata + ")");
                        if (jsondata.state == 200) {
                            show_informer();
                            get_plate_timezone();
                        }
                    });
                }

                $(function () {
                    if (g_style_time == "sfm") {
                        $(".sfm_hide_tr").show();
                        $(".dummy").css("margin","0 50px");
                    }
                    $("select").parent().css("font-size", '10px');
                    init_selectmenu("#hour,#min,#sec,#ntp_frequency_hour,#ntp_frequency_minute,#ntp_frequency_second", 60, 150);
                    //显示时钟
                    //$.get("../vb.htm",{getdate:"",gettime:""}, get_server_date);
                    get_server_datatime();
                    setInterval(function () {
                        get_server_datatime();
                    }, 5000);
                    $("#submit").click(set_sever_date);
                    get_ntp();
                    $("#ntp_submit").click(set_ntp);
                    init_selectmenu("#plate_timezone", 180, 150);
                    get_plate_timezone();
                });
                function set_sever_date()
                {
                    sfm_cur_obj = $(this);
                    if($("#radio1").check_val())
                    {
                        if($("#manualdate").val()!="")
                        {
                            var ld = $("#manualdate").val();
                            //简单的日期格式判断
                            if(!ld.match(/^(0?\d|1[012])\/(0?\d|10|[12]\d|3[01])\/(19|20)\d{2}$/))
                            {
                                alert("日期格式不符");
                                return;
                            }
                            ld=ld.split("/");
                            ld = ld[2]+"/"+ld[0]+"/"+ld[1];
                            var lt = $("#hour").val()+":"+$("#min").val()+":"+$("#sec").val();
                            $.get("../vb.htm",{newdate:ld,newtime:lt}, function(ajaxdata){
                                default_ajax_handler(ajaxdata);
                                $.get("../vb.htm",{getdate:"",gettime:""}, set_g_systime);
                            });
                        }
                        else
                        {
                            alert("请选择日期");
                            return;
                        }
                    }
                    else if($("#radio2").check_val())
                    {
                        var ld = $("#localdate").val();
                        var lt = $("#localtime").val();
                        if(!ld.match(/^(0?\d|1[012])\/(0?\d|10|[12]\d|3[01])\/(19|20)\d{2}$/))
                        {
                            alert("日期格式不符");
                            return;
                        }
                        if(!lt.match(/^([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/))
                        {
                            alert("时间格式不符");
                            return;
                        }
                        ld=ld.split("/");
                        ld = ld[2]+"/"+ld[0]+"/"+ld[1];
                        $.get("../vb.htm",{newdate:ld,newtime:lt}, function(ajaxdata){
                            default_ajax_handler(ajaxdata);
                            $.get("../vb.htm",{getdate:"",gettime:""}, set_g_systime);
                        });
                    }
                    //else
                    //{
                    //    alert("请选择一种设置方式");
                    //}
                    set_plate_timezone();
                }
            });
        });
    </script>

</head>
<body>
    <table class="dummy" cellpadding="0" cellspacing="0" style="margin: 30px auto;">        
        <tr><td></td></tr>
        <tr>
            <td>时区</td>
            <td colspan="2" align="left">
                <select id="plate_timezone">
                    <option value="0">格林威治(UTC)</option>
                    <option value="8">北京时间(UTC+08:00)</option>
                </select>
            </td>
        </tr>
        <tr>
            <td style="min-width:100px;">
                相机日期/时间
            </td>
            <td style="min-width:30px;">
                日期
            </td>
            <td>
                <input id="serverdate" type="text" value="" size="11" />
            </td>
            <td style="min-width:30px;">
                时间
            </td>
            <td>
                <input id="servertime" type="text" value="" size="11" />
            </td>
            <td style="width:150px;"></td>
        </tr>
        <tr>
            <td>
                设置时间
            </td>
            <td colspan="2">
                <input type="radio" id="radio1" name="radio" value="radiobutton" />
                <label for="radio1">
                    手动设置</label>
            </td>
        </tr>
        <tr>
            <td rowspan="3">
            </td>
            <td>
                日期
            </td>
            <td>
                <input id="manualdate" class="datepicker" type="text" size="11" />
            </td>
            <td>
                时间
            </td>
            <td colspan="2">
                <table class="innertable" cellpadding="0" cellspacing="0">
                    <tr>
                        <td style="padding-left:2px;">
                            <select id="hour" style="width: 5em">
                                <option>00</option><option>01</option><option>02</option><option>03</option><option>04</option><option>05</option>
                                <option>06</option><option>07</option><option>08</option><option>09</option><option>10</option><option>11</option>
                                <option>12</option><option>13</option><option>14</option><option>15</option><option>16</option><option>17</option>
                                <option>18</option><option>19</option><option>20</option><option>21</option><option>22</option><option>23</option>
                            </select>
                        </td>
                        <td >
                            时
                        </td>
                        
                        <td >
                            <select id="min" style="width: 5em">
                                <option>00</option><option>01</option><option>02</option><option>03</option><option>04</option><option>05</option>
                                <option>06</option><option>07</option><option>08</option><option>09</option><option>10</option><option>11</option>
                                <option>12</option><option>13</option><option>14</option><option>15</option><option>16</option><option>17</option>
                                <option>18</option><option>19</option><option>20</option><option>21</option><option>22</option><option>23</option>
                                <option>24</option><option>25</option><option>26</option><option>27</option><option>28</option><option>29</option>
                                <option>30</option><option>31</option><option>32</option><option>33</option><option>34</option><option>35</option>
                                <option>36</option><option>37</option><option>38</option><option>39</option><option>40</option><option>41</option>
                                <option>42</option><option>43</option><option>44</option><option>45</option><option>46</option><option>47</option>
                                <option>48</option><option>49</option><option>50</option><option>51</option><option>52</option><option>53</option>
                                <option>54</option><option>55</option><option>56</option><option>57</option><option>58</option><option>59</option>
                            </select>
                        </td>
                        <td>
                            分
                        </td>
                        
                        <td >
                            <select id="sec" style="width: 5em">
                                <option>00</option><option>01</option><option>02</option><option>03</option><option>04</option><option>05</option>
                                <option>06</option><option>07</option><option>08</option><option>09</option><option>10</option><option>11</option>
                                <option>12</option><option>13</option><option>14</option><option>15</option><option>16</option><option>17</option>
                                <option>18</option><option>19</option><option>20</option><option>21</option><option>22</option><option>23</option>
                                <option>24</option><option>25</option><option>26</option><option>27</option><option>28</option><option>29</option>
                                <option>30</option><option>31</option><option>32</option><option>33</option><option>34</option><option>35</option>
                                <option>36</option><option>37</option><option>38</option><option>39</option><option>40</option><option>41</option>
                                <option>42</option><option>43</option><option>44</option><option>45</option><option>46</option><option>47</option>
                                <option>48</option><option>49</option><option>50</option><option>51</option><option>52</option><option>53</option>
                                <option>54</option><option>55</option><option>56</option><option>57</option><option>58</option><option>59</option>
                            </select>
                        </td>
                        <td>
                            秒
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <input type="radio" id="radio2" name="radio" value="radiobutton" />
                <label for="radio2">
                    与本机时间同步</label>
            </td>
        </tr>
        <tr>
            <td>
                日期
            </td>
            <td>
                <input id="localdate" type="text" value="" size="11" />
            </td>
            <td>
                时间
            </td>
            <td>
                <input id="localtime" type="text" value="" size="11" />
            </td>
        </tr>
        <tr><td></td></tr>
        <tr class="sfm_hide_tr" style="display:none;"><td></td></tr>
        <tr>
            <td></td>
            <td>
                <input id="submit" type="submit" value="确定" />
            </td>
            <td style="display:none;" align="left" class="sfm_info"></td>            
        </tr>
        <tr><td></td></tr>
        <tr class="sfm_hide_tr" style="display:none;"><td></td></tr>
        <tr>
            <td >
                   ntp时间服务器    
            </td>
            <td colspan="2">
                <input id="ntp_enable" type="checkbox" />
                <label for="ntp_enable">
                    启用</label>
            </td>
        </tr>
        <tr>
            <td rowspan="3">
            </td>
            <td>
                 地址
            </td>
            <td>
                <input id="ntp_server_name" type="text" size="20" />
            </td>
        </tr>
        <tr>
            <td>
                 访问频率
            </td>
            <td colspan="3">
                <table class="innertable" cellpadding="0" cellspacing="0">
                    <tr>
                        <td>每</td>
                        <td style="padding-left:2px;">
                            <select id="ntp_frequency_hour" style="width: 5em">
                                <option value="0">00</option>
                                <option value="1">01</option>
                                <option value="2">02</option>
                                <option value="3">03</option>
                                <option value="4">04</option>
                                <option value="5">05</option>
                                <option value="6">06</option>
                                <option value="7">07</option>
                                <option value="8">08</option>
                                <option value="9">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                                <option value="21">21</option>
                                <option value="22">22</option>
                                <option value="23">23</option>
                            </select>
                        </td>
                        <td >
                            时
                        </td>
                        
                        <td >
                            <select id="ntp_frequency_minute" style="width: 5em">
                                <option value="0">00</option>
                                <option value="1">01</option>
                                <option value="2">02</option>
                                <option value="3">03</option>
                                <option value="4">04</option>
                                <option value="5">05</option>
                                <option value="6">06</option>
                                <option value="7">07</option>
                                <option value="8">08</option>
                                <option value="9">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                                <option value="21">21</option>
                                <option value="22">22</option>
                                <option value="23">23</option>
                                <option value="24">24</option>
                                <option value="25">25</option>
                                <option value="26">26</option>
                                <option value="27">27</option>
                                <option value="28">28</option>
                                <option value="29">29</option>
                                <option value="30">30</option>
                                <option value="31">31</option>
                                <option value="32">32</option>
                                <option value="33">33</option>
                                <option value="34">34</option>
                                <option value="35">35</option>
                                <option value="36">36</option>
                                <option value="37">37</option>
                                <option value="38">38</option>
                                <option value="39">39</option>
                                <option value="40">40</option>
                                <option value="41">41</option>
                                <option value="42">42</option>
                                <option value="43">43</option>
                                <option value="44">44</option>
                                <option value="45">45</option>
                                <option value="46">46</option>
                                <option value="47">47</option>
                                <option value="48">48</option>
                                <option value="49">49</option>
                                <option value="50">50</option>
                                <option value="51">51</option>
                                <option value="52">52</option>
                                <option value="53">53</option>
                                <option value="54">54</option>
                                <option value="55">55</option>
                                <option value="56">56</option>
                                <option value="57">57</option>
                                <option value="58">58</option>
                                <option value="59">59</option>
                            </select>
                        </td>
                        <td>
                            分
                        </td>
                        
                        <td >
                            <select id="ntp_frequency_second" style="width: 5em">
                                <option value="0">00</option>
                                <option value="1">01</option>
                                <option value="2">02</option>
                                <option value="3">03</option>
                                <option value="4">04</option>
                                <option value="5">05</option>
                                <option value="6">06</option>
                                <option value="7">07</option>
                                <option value="8">08</option>
                                <option value="9">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                                <option value="21">21</option>
                                <option value="22">22</option>
                                <option value="23">23</option>
                                <option value="24">24</option>
                                <option value="25">25</option>
                                <option value="26">26</option>
                                <option value="27">27</option>
                                <option value="28">28</option>
                                <option value="29">29</option>
                                <option value="30">30</option>
                                <option value="31">31</option>
                                <option value="32">32</option>
                                <option value="33">33</option>
                                <option value="34">34</option>
                                <option value="35">35</option>
                                <option value="36">36</option>
                                <option value="37">37</option>
                                <option value="38">38</option>
                                <option value="39">39</option>
                                <option value="40">40</option>
                                <option value="41">41</option>
                                <option value="42">42</option>
                                <option value="43">43</option>
                                <option value="44">44</option>
                                <option value="45">45</option>
                                <option value="46">46</option>
                                <option value="47">47</option>
                                <option value="48">48</option>
                                <option value="49">49</option>
                                <option value="50">50</option>
                                <option value="51">51</option>
                                <option value="52">52</option>
                                <option value="53">53</option>
                                <option value="54">54</option>
                                <option value="55">55</option>
                                <option value="56">56</option>
                                <option value="57">57</option>
                                <option value="58">58</option>
                                <option value="59">59</option>
                            </select>
                        </td>
                        <td>
                            秒
                        </td>
                        <td>同步一次</td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr><td></td></tr>
        <tr>
            <td></td>
            <td>
                <input id="ntp_submit" type="submit" value="确定" />
            </td>
            <td style="display:none;" align="left" class="sfm_info"></td>               
        </tr>
    </table>   
</body>
</html>
