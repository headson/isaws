<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>设置日期/时间</title>

  <script src="../js/jquery-1.11.2.min.js"></script>
  <script src="../js/base64.js"></script>
  <script src="../js/utf8.js"></script>

</head>
<body>
  <table class="dummy" cellpadding="0" cellspacing="0" style="margin: 30px auto;">
    <tr><td></td></tr>
    <tr>
      <td>时区</td>
      <td colspan="2" align="left">
        <select id="timezone">
          <option value="0">格林威治(UTC)</option>
          <option value="8">北京时间(UTC+08:00)</option>
        </select>
      </td>
    </tr>
    <tr>
      <td style="min-width:100px;">
        相机日期/时间
      </td>
      <td style="min-width:30px;">
        日期
      </td>
      <td>
        <input id="serverdate" type="text" value="" size="11" />
      </td>
      <td style="min-width:30px;">
        时间
      </td>
      <td>
        <input id="servertime" type="text" value="" size="11" />
      </td>
      <td style="width:150px;"></td>
    </tr>
    <tr>
      <td>
        设置时间
      </td>
      <td colspan="2">
        <input type="radio" id="radio1" name="radio" value="radiobutton" />
        <label for="radio1">
          手动设置
        </label>
      </td>
    </tr>
    <tr>
      <td rowspan="3"></td>
      <td>
        日期
      </td>
      <td>
        <input id="manualdate" class="datepicker" type="text" size="11" />
      </td>
      <td>
        时间
      </td>
      <td colspan="2">
        <table class="innertable" cellpadding="0" cellspacing="0">
          <tr>
            <td style="padding-left:2px;">
              <select id="hour" style="width: 5em">
                <option>00</option>
                <option>01</option>
                <option>02</option>
                <option>03</option>
                <option>04</option>
                <option>05</option>
                <option>06</option>
                <option>07</option>
                <option>08</option>
                <option>09</option>
                <option>10</option>
                <option>11</option>
                <option>12</option>
                <option>13</option>
                <option>14</option>
                <option>15</option>
                <option>16</option>
                <option>17</option>
                <option>18</option>
                <option>19</option>
                <option>20</option>
                <option>21</option>
                <option>22</option>
                <option>23</option>
              </select>
            </td>
            <td>
              时
            </td>

            <td>
              <select id="min" style="width: 5em">
                <option>00</option>
                <option>01</option>
                <option>02</option>
                <option>03</option>
                <option>04</option>
                <option>05</option>
                <option>06</option>
                <option>07</option>
                <option>08</option>
                <option>09</option>
                <option>10</option>
                <option>11</option>
                <option>12</option>
                <option>13</option>
                <option>14</option>
                <option>15</option>
                <option>16</option>
                <option>17</option>
                <option>18</option>
                <option>19</option>
                <option>20</option>
                <option>21</option>
                <option>22</option>
                <option>23</option>
                <option>24</option>
                <option>25</option>
                <option>26</option>
                <option>27</option>
                <option>28</option>
                <option>29</option>
                <option>30</option>
                <option>31</option>
                <option>32</option>
                <option>33</option>
                <option>34</option>
                <option>35</option>
                <option>36</option>
                <option>37</option>
                <option>38</option>
                <option>39</option>
                <option>40</option>
                <option>41</option>
                <option>42</option>
                <option>43</option>
                <option>44</option>
                <option>45</option>
                <option>46</option>
                <option>47</option>
                <option>48</option>
                <option>49</option>
                <option>50</option>
                <option>51</option>
                <option>52</option>
                <option>53</option>
                <option>54</option>
                <option>55</option>
                <option>56</option>
                <option>57</option>
                <option>58</option>
                <option>59</option>
              </select>
            </td>
            <td>
              分
            </td>

            <td>
              <select id="sec" style="width: 5em">
                <option>00</option>
                <option>01</option>
                <option>02</option>
                <option>03</option>
                <option>04</option>
                <option>05</option>
                <option>06</option>
                <option>07</option>
                <option>08</option>
                <option>09</option>
                <option>10</option>
                <option>11</option>
                <option>12</option>
                <option>13</option>
                <option>14</option>
                <option>15</option>
                <option>16</option>
                <option>17</option>
                <option>18</option>
                <option>19</option>
                <option>20</option>
                <option>21</option>
                <option>22</option>
                <option>23</option>
                <option>24</option>
                <option>25</option>
                <option>26</option>
                <option>27</option>
                <option>28</option>
                <option>29</option>
                <option>30</option>
                <option>31</option>
                <option>32</option>
                <option>33</option>
                <option>34</option>
                <option>35</option>
                <option>36</option>
                <option>37</option>
                <option>38</option>
                <option>39</option>
                <option>40</option>
                <option>41</option>
                <option>42</option>
                <option>43</option>
                <option>44</option>
                <option>45</option>
                <option>46</option>
                <option>47</option>
                <option>48</option>
                <option>49</option>
                <option>50</option>
                <option>51</option>
                <option>52</option>
                <option>53</option>
                <option>54</option>
                <option>55</option>
                <option>56</option>
                <option>57</option>
                <option>58</option>
                <option>59</option>
              </select>
            </td>
            <td>
              秒
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <input type="radio" id="radio2" name="radio" value="radiobutton" />
        <label for="radio2">
          与本机时间同步
        </label>
      </td>
    </tr>
    <tr>
      <td>
        日期
      </td>
      <td>
        <input id="localdate" type="text" value="" size="11" />
      </td>
      <td>
        时间
      </td>
      <td>
        <input id="localtime" type="text" value="" size="11" />
      </td>
    </tr>
    <tr><td></td></tr>
    <tr class="sfm_hide_tr" style="display:none;"><td></td></tr>
    <tr>
      <td></td>
      <td>
        <input id="set_devtime" type="submit" value="确定" />
      </td>
      <td style="display:none;" align="left" class="sfm_info"></td>
    </tr>
    <tr><td></td></tr>
    <tr class="sfm_hide_tr" style="display:none;"><td></td></tr>
    <tr>
      <td>
        ntp时间服务器
      </td>
      <td colspan="2">
        <input id="ntp_enable" type="checkbox" />
        <label for="ntp_enable">
          启用
        </label>
      </td>
    </tr>
    <tr>
      <td rowspan="3"></td>
      <td>
        地址
      </td>
      <td>
        <input id="ntp_server_name" type="text" size="20" />
      </td>
    </tr>
    <tr>
      <td>
        访问频率
      </td>
      <td>
        <input id="ntp_frequency_ms" type="text" size="20" />毫秒
      </td>

    </tr>
    <tr><td></td></tr>
    <tr>
      <td></td>
      <td>
        <input id="set_timeinfo" type="submit" value="确定" />
      </td>
      <td style="display:none;" align="left" class="sfm_info"></td>
    </tr>
  </table>


  <script>
    Date.prototype.format = function (fmt) { //author: meizz
      var o = {
        "M+": this.getMonth() + 1, //月份
        "D+": this.getDate(), //日
        "h+": this.getHours(), //小时
        "m+": this.getMinutes(), //分
        "s+": this.getSeconds(), //秒
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度
        "S": this.getMilliseconds() //毫秒
      };
      if (/(Y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
      for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
      return fmt;
    }

    jQuery.fn.select_val = function (value) {
      if (arguments.length) {
        if (this.children('option[value="' + value + '"]').length > 0) {
          this.val(value);
          // this.selectmenu("refresh");
        }
      }
      else {
        return this.val();
      }
    }
    
    jQuery.fn.check_val = function (value) {
      if (arguments.length) {
        this.attr('checked', value);
      }
      else {
        return this.is(':checked');
      }
    }

    //global var
    var g_systime = 0;
    function refresh_datetime() {
      g_systime += 1000;
      var local_date = new Date();
      var ld = local_date.format("YYYY-MM-DD");
      var lt = local_date.format("hh:mm:ss");
      var sys_date = new Date(g_systime);
      var sd = sys_date.format("YYYY-MM-DD");
      var st = sys_date.format("hh:mm:ss");
      if ($("#localdate").val() != ld) {
        $("#localdate").val(ld);
      }
      if ($("#localtime").val() != lt) {
        $("#localtime").val(lt);
      }
      if ($("#serverdate").val() != sd) {
        $("#serverdate").val(sd);
      }
      if ($("#servertime").val() != st) {
        $("#servertime").val(st);
      }

      setTimeout(refresh_datetime, 1000);
    }

    function get_timeinfo() {
      var req = {};
      req.cmd = 'get_timeinfo';
      req.id = 1;
      req.body = {};
      var jsonstr = JSON.stringify(req);

      $.ajax({
        type: 'POST',
        url: '/dispatch',
        dataType: 'text',
        data: jsonstr,
        success: function (ajaxdata) {
          var jresp = eval('(' + ajaxdata + ')');
          if (jresp.state == 200) {
            response = jresp.body.datetime.split(" ");
            var msgdate = response[0].split("-");
            var year = msgdate[0];
            var month = msgdate[1] - 1;
            var date = msgdate[2];
            var msgtime = response[1].split(":");
            var hours = msgtime[0];
            var minutes = msgtime[1];
            var seconds = msgtime[2];
            var sys_date = new Date(year, month, date, hours, minutes, seconds);
            g_systime = sys_date.getTime();

            $("#timezone").select_val(jresp.body.timezone);

            $('#ntp_enable').check_val(jresp.body.ntp.enable == 1);

            $('#ntp_server_name').val(jresp.body.ntp.server);
            $('#ntp_frequency_ms').val(jresp.body.ntp.timeout);
          } else {
            alert('获取时间信息错误!');
          }
        }
      });
    }

    function set_timeinfo() {
      var req = {};
      req.cmd = 'set_timeinfo';
      req.id = 1;
      req.body = {};

      req.body.timezone = parseInt($('#timezone').select_val());

      req.body.ntp = {};
      req.body.ntp.enable = $('#ntp_enable').check_val() ? 1 : 0;
      req.body.ntp.server = $('#ntp_server_name').val();
      req.body.ntp.timeout = parseInt($('#ntp_frequency_ms').val());

      var jsonstr = JSON.stringify(req);

      $.ajax({
        type: 'POST',
        url: '/dispatch',
        dataType: 'text',
        data: jsonstr,
        success: function (ajaxdata) {
          var jresp = eval('(' + ajaxdata + ')');
          if (jresp.state == 200) {
            alert('设置时间信息成功!');
          } else {
            alert('设置时间信息错误!');
          }
          get_timeinfo();
        }
      });
    }

    function set_devtime() {
      var req = {};
      req.cmd = 'set_devtime';
      req.id = 1;
      req.body = {};
      if ($("#radio1").check_val()) {
        var ld = $("#manualdate").val();
        //简单的日期格式判断
        //if (!ld.match(/^(0?\d|1[012])\/(0?\d|10|[12]\d|3[01])\/(19|20)\d{2}$/)) {
        //  alert("日期格式不符");
        //  return;
        //}
        var lt = $("#hour").val() + ":" + $("#min").val() + ":" + $("#sec").val();

        req.body.datetime = ld + " " + lt;
      } else if ($("#radio2").check_val()) {
        req.body.datetime = $('#localdate').val() + " " + $('#localtime').val();
      } else {
        alert("请选择日期");
        return;
      }
      var jsonstr = JSON.stringify(req);

      $.ajax({
        type: 'POST',
        url: '/dispatch',
        dataType: 'text',
        data: jsonstr,
        success: function (ajaxdata) {
          var jresp = eval('(' + ajaxdata + ')');
          if (jresp.state == 200) {
            alert('配置设备时间成功!');
          } else {
            alert('配置设备时间错误!');
          }
        }
      });
    }

    $(document).ready(function () {
      $(window).ready(function () {
        get_timeinfo();

        refresh_datetime();
      });

      $('#set_devtime').click(function () {
        set_devtime();

        get_timeinfo();
      });

      $('#set_timeinfo').click(function () {
        set_timeinfo();
      });
    });
  </script>

</body>
</html>
